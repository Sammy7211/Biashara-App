<h2>Checkout</h2>

<% if (cart.length === 0) { %>
  <p>Your cart is empty.</p>
  <a href="/products" class="btn btn-primary">Continue Shopping</a>
<% } else { %>

  <form action="/checkout" method="POST" class="mt-3">
    <!-- Customer Name -->
    <div class="mb-3">
      <label class="form-label">Full Name</label>
      <input type="text" name="customerName" class="form-control" required>
    </div>

    <!-- Phone -->
    <div class="mb-3">
      <label class="form-label">Phone Number</label>
      <input type="text" name="phone" class="form-control" required>
    </div>

    <!-- Address Section -->
    <div class="mb-3">
      <label class="form-label">Delivery Address</label>
      <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#addAddressModal">
        Add Address
      </button>
      <!-- Hidden input to store full address -->
      <input type="hidden" name="fullAddress" id="fullAddressInput" required>
      <div id="selectedAddress" class="mt-2 text-muted"></div>
    </div>

    <!-- Order Summary -->
    <h4 class="mt-4">Order Summary</h4>
    <ul class="list-group mb-4">
      <% let total = 0; %>
      <% cart.forEach(item => { total += item.quantity * item.price; %>
        <li class="list-group-item">
          <%= item.name %> x <%= item.quantity %> â€” KES <%= item.quantity * item.price %>
        </li>
      <% }) %>
      <li class="list-group-item active">
        Total: KES <%= total %>
      </li>
    </ul>

    <button class="btn btn-success w-100" type="submit">Confirm Order</button>
  </form>

  <!-- Address Modal -->
  <div class="modal fade" id="addAddressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Delivery Address</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Address Line 1</label>
            <input type="text" id="address1" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Address Line 2 (optional)</label>
            <input type="text" id="address2" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">City</label>
            <input type="text" id="city" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Postal Code</label>
            <input type="text" id="postalCode" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="saveAddressBtn" class="btn btn-primary">Save Address</button>
        </div>
      </div>
    </div>
  </div>

<% } %>

<script>
  // Save address from modal into hidden input
  document.getElementById("saveAddressBtn").addEventListener("click", function () {
    const address1 = document.getElementById("address1").value.trim();
    const address2 = document.getElementById("address2").value.trim();
    const city = document.getElementById("city").value.trim();
    const postalCode = document.getElementById("postalCode").value.trim();

    if (!address1 || !city || !postalCode) {
      alert("Please fill in all required address fields.");
      return;
    }

    const fullAddress = `${address1}${address2 ? ", " + address2 : ""}, ${city}, ${postalCode}`;
    document.getElementById("fullAddressInput").value = fullAddress;
    document.getElementById("selectedAddress").innerHTML = `<p class="m-0">${fullAddress}</p>`;

    const modal = bootstrap.Modal.getInstance(document.getElementById("addAddressModal"));
    modal.hide();
  });

  // Prevent checkout form submission without address
  document.querySelector("form[action='/checkout']").addEventListener("submit", function (e) {
    const fullAddress = document.getElementById("fullAddressInput").value.trim();
    if (!fullAddress) {
      e.preventDefault();
      alert("Please add a delivery address before confirming your order.");
    }
  });
</script>
